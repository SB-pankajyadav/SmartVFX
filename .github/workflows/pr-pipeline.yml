name: Pipeline - Security Audit

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  setup:
    name: Setup Workspace
    uses: ./.github/workflows/setup.yml
  
  audit:
    name: Vulnerability Audit
    needs: setup
    uses: ./.github/workflows/audit.yml
  
  generate-pre-fix-report:
    name: Generate Pre-Fix Vulnerability Report
    runs-on: ubuntu-latest
    needs: audit
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Generate vulnerability report
        run: node ./packages/audit/run-audit.js ./reports/pre-fix
        continue-on-error: true
      
      - name: Display pre-fix report
        run: |
          echo "üìã Pre-Fix Vulnerability Report"
          echo "================================"
          if [ -f reports/pre-fix/vulnerability_report.json ]; then
            cat reports/pre-fix/vulnerability_report.json
          else
            echo "No vulnerability report found"
          fi
          
          if [ -f reports/pre-fix/vulnerability_dashboard.json ]; then
            echo ""
            echo "üìä Vulnerability Dashboard:"
            cat reports/pre-fix/vulnerability_dashboard.json
          fi
      
      - name: Upload pre-fix report
        uses: actions/upload-artifact@v4
        with:
          name: pre-fix-vulnerability-report
          path: reports/pre-fix/
          if-no-files-found: warn
  
  approval:
    name: Manual Approval Required
    runs-on: ubuntu-latest
    needs: [setup, audit, generate-pre-fix-report]
    environment: production-approval
    steps:
      - name: Review required
        run: |
          echo "‚úÖ Setup job status: ${{ needs.setup.result }}"
          echo "‚úÖ Audit job status: ${{ needs.audit.result }}"
          echo "‚úÖ Pre-fix report status: ${{ needs.generate-pre-fix-report.result }}"
          echo ""
          echo "‚è∏Ô∏è  Manual approval required to proceed with fixes"
          echo "Review the vulnerability report and approve to continue"
  
  project-setup:
    name: Project Setup
    runs-on: ubuntu-latest
    needs: approval
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Run project setup
        run: npm run project-setup
  
  start-application:
    name: Start Application
    runs-on: ubuntu-latest
    needs: project-setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Start application
        run: |
          echo "Starting application..."
          timeout 10s npm start || echo "Application started and stopped after timeout"
  
  py-setup:
    name: Python Setup
    runs-on: ubuntu-latest
    needs: project-setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Run Python setup
        run: npm run py-setup
  
  autofix:
    name: Auto Fix Vulnerabilities
    runs-on: ubuntu-latest
    needs: [project-setup, py-setup]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install Node dependencies
        run: npm install
      
      - name: Install Python dependencies
        run: pip install -r packages/autofix/requirements.txt
      
      - name: Run autofix
        run: npm run autofix
        continue-on-error: true
  
  generate-post-fix-report:
    name: Generate Post-Fix Vulnerability Report
    runs-on: ubuntu-latest
    needs: autofix
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Generate post-fix vulnerability report
        run: node ./packages/audit/run-audit.js ./reports/post-fix
        continue-on-error: true
      
      - name: Display post-fix report
        run: |
          echo "üìã Post-Fix Vulnerability Report"
          echo "================================="
          if [ -f reports/post-fix/vulnerability_report.json ]; then
            cat reports/post-fix/vulnerability_report.json
          else
            echo "No vulnerability report found"
          fi
          
          if [ -f reports/post-fix/vulnerability_dashboard.json ]; then
            echo ""
            echo "üìä Post-Fix Vulnerability Dashboard:"
            cat reports/post-fix/vulnerability_dashboard.json
          fi
      
      - name: Upload post-fix report
        uses: actions/upload-artifact@v4
        with:
          name: post-fix-vulnerability-report
          path: reports/post-fix/
          if-no-files-found: warn
  
  pipeline-summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [setup, audit, generate-pre-fix-report, approval, project-setup, start-application, py-setup, autofix, generate-post-fix-report]
    if: always()
    
    steps:
      - name: Check pipeline status
        run: |
          echo "Pipeline execution completed"
          echo "================================="
          echo "Setup job status: ${{ needs.setup.result }}"
          echo "Audit job status: ${{ needs.audit.result }}"
          echo "Pre-fix Report status: ${{ needs.generate-pre-fix-report.result }}"
          echo "Approval job status: ${{ needs.approval.result }}"
          echo "Project Setup job status: ${{ needs.project-setup.result }}"
          echo "Start Application job status: ${{ needs.start-application.result }}"
          echo "Python Setup job status: ${{ needs.py-setup.result }}"
          echo "Autofix job status: ${{ needs.autofix.result }}"
          echo "Post-fix Report status: ${{ needs.generate-post-fix-report.result }}"
          echo "================================="
          
          if [ "${{ needs.setup.result }}" != "success" ]; then
            echo "‚ùå Setup job failed"
            exit 1
          fi
          
          if [ "${{ needs.audit.result }}" != "success" ]; then
            echo "‚ö†Ô∏è Audit job completed with warnings or errors"
          fi
          
          if [ "${{ needs.approval.result }}" == "success" ]; then
            echo "‚úÖ Approval granted and post-approval jobs executed"
            
            if [ "${{ needs.generate-post-fix-report.result }}" == "success" ]; then
              echo "‚úÖ Post-fix vulnerability report generated"
              echo "üìä Compare pre-fix and post-fix reports in artifacts"
            fi
          else
            echo "‚ö†Ô∏è Approval was not granted or skipped"
          fi
          
          echo ""
          echo "‚úÖ Pipeline completed successfully"
