name: Pipeline - Security Audit

on:
  push:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  setup:
    name: Setup Workspace
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
  
  audit:
    name: Run Vulnerability Audit (npm audit)
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Create reports directory
        run: mkdir -p reports/audit
      
      - name: Run audit script
        run: npm run audit
        continue-on-error: true
      
      - name: Display audit results
        run: |
          echo "üìã Audit Results"
          if [ -f packages/audit/vulnerability_report.json ]; then
            cat packages/audit/vulnerability_report.json
          fi
  
  generate-pre-fix-report:
    name: Generate Pre-Fix Vulnerability Report
    runs-on: ubuntu-latest
    needs: audit
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Create reports directories
        run: mkdir -p reports/pre-fix packages/audit
      
      - name: Generate vulnerability report for autofix
        run: node ./packages/audit/run-audit.js ./packages/audit
        continue-on-error: true
      
      - name: Copy pre-fix report for artifacts
        run: |
          cp packages/audit/vulnerability_report.json reports/pre-fix/
          cp packages/audit/vulnerability_dashboard.json reports/pre-fix/
      
      - name: Display pre-fix report
        run: |
          echo "üìã Pre-Fix Vulnerability Report"
          echo "================================"
          if [ -f reports/pre-fix/vulnerability_report.json ]; then
            cat reports/pre-fix/vulnerability_report.json
          else
            echo "No vulnerability report found"
          fi
          
          if [ -f reports/pre-fix/vulnerability_dashboard.json ]; then
            echo ""
            echo "üìä Vulnerability Dashboard:"
            cat reports/pre-fix/vulnerability_dashboard.json
          fi
      
      - name: Upload pre-fix report
        uses: actions/upload-artifact@v4
        with:
          name: pre-fix-vulnerability-report
          path: reports/pre-fix/
          if-no-files-found: warn
  
  project-setup:
    name: Project Setup (npm install + py-setup)
    runs-on: ubuntu-latest
    needs: generate-pre-fix-report
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Create reports directory
        run: mkdir -p reports/project-setup
      
      - name: Run project setup
        run: npm run project-setup
      
      - name: Log project setup completion
        run: |
          echo "Project setup completed at $(date)" > reports/project-setup/setup-log.txt
          echo "Setup includes: npm install + py-setup" >> reports/project-setup/setup-log.txt
          cat reports/project-setup/setup-log.txt
      
      - name: Upload project setup report
        uses: actions/upload-artifact@v4
        with:
          name: project-setup-report
          path: reports/project-setup/
          if-no-files-found: warn
  
  start:
    name: Start Application (npm start)
    runs-on: ubuntu-latest
    needs: project-setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Create reports directory
        run: mkdir -p reports/start-app
      
      - name: Start application
        run: |
          echo "Starting application..."
          timeout 10s npm start || echo "Application started and stopped after timeout"
      
      - name: Log application start
        run: |
          echo "Application start attempt completed at $(date)" > reports/start-app/start-log.txt
          echo "Started with: npm start" >> reports/start-app/start-log.txt
          cat reports/start-app/start-log.txt
      
      - name: Upload start report
        uses: actions/upload-artifact@v4
        with:
          name: start-app-report
          path: reports/start-app/
          if-no-files-found: warn
  
  py-setup:
    name: Python Setup (npm run py-setup)
    runs-on: ubuntu-latest
    needs: project-setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Create reports directory
        run: mkdir -p reports/py-setup
      
      - name: Run Python setup
        run: npm run py-setup
      
      - name: Log python setup completion
        run: |
          echo "Python setup completed at $(date)" > reports/py-setup/py-setup-log.txt
          echo "Setup script: autofix_setup.sh" >> reports/py-setup/py-setup-log.txt
          cat reports/py-setup/py-setup-log.txt
      
      - name: Upload python setup report
        uses: actions/upload-artifact@v4
        with:
          name: py-setup-report
          path: reports/py-setup/
          if-no-files-found: warn
  
  autofix:
    name: Auto Fix Vulnerabilities (npm run autofix)
    runs-on: ubuntu-latest
    needs: [project-setup, py-setup]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install Node dependencies
        run: npm install
      
      - name: Install Python dependencies
        run: pip install -r packages/autofix/requirements.txt
      
      - name: Create reports directory
        run: mkdir -p reports/autofix packages/audit
      
      - name: Generate vulnerability report for autofix input
        run: node ./packages/audit/run-audit.js ./packages/audit
        continue-on-error: true
      
      - name: Run autofix with Google Gemini API
        env:
          GOOGLE_GENAI_API_KEY: ${{ secrets.HACKATHON_PROJECT }}
        run: |
          echo "Running autofix with Google Gemini AI..."
          echo "API Key status: $(if [ -n "$GOOGLE_GENAI_API_KEY" ]; then echo 'SET'; else echo 'NOT SET'; fi)"
          echo "---" >> reports/autofix/autofix-log.txt
          python3 ./packages/autofix/llm.py 2>&1 | tee -a reports/autofix/autofix-log.txt
          EXIT_CODE=$?
          echo "Autofix exit code: $EXIT_CODE" | tee -a reports/autofix/autofix-log.txt
        continue-on-error: true
      
      - name: Check if package.json was updated
        run: |
          echo "---" >> reports/autofix/autofix-log.txt
          echo "Checking package.json changes..." | tee -a reports/autofix/autofix-log.txt
          if git diff --exit-code package.json > /dev/null 2>&1; then
            echo "‚ùå No changes to package.json detected" | tee -a reports/autofix/autofix-log.txt
          else
            echo "‚úÖ package.json was updated:" | tee -a reports/autofix/autofix-log.txt
            git diff package.json | tee -a reports/autofix/autofix-log.txt
          fi
      
      - name: Reinstall dependencies with updated package.json
        run: |
          echo "Installing updated dependencies..." | tee -a reports/autofix/autofix-log.txt
          npm install 2>&1 | tee -a reports/autofix/autofix-log.txt
        continue-on-error: true
      
      - name: Upload modified package.json
        uses: actions/upload-artifact@v4
        with:
          name: updated-package-json
          path: package.json
          if-no-files-found: warn
      
      - name: Upload autofix report
        uses: actions/upload-artifact@v4
        with:
          name: autofix-report
          path: reports/autofix/
          if-no-files-found: warn
  
  generate-post-fix-report:
    name: Generate Post-Fix Vulnerability Report
    runs-on: ubuntu-latest
    needs: autofix
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Download updated package.json from autofix
        uses: actions/download-artifact@v4
        with:
          name: updated-package-json
          path: .
        continue-on-error: true
      
      - name: Download pre-fix report for comparison
        uses: actions/download-artifact@v4
        with:
          name: pre-fix-vulnerability-report
          path: reports/pre-fix-comparison/
        continue-on-error: true
      
      - name: Verify package.json was downloaded and updated
        run: |
          if [ -f package.json ]; then
            echo "‚úÖ package.json found"
            echo "üì¶ Checking if package.json was modified by autofix..."
            
            # Compare with original to see if it was updated
            git fetch origin
            if git diff HEAD package.json | grep -q "express\|mongoose\|body-parser\|jsonwebtoken\|lodash\|got"; then
              echo "‚úÖ package.json has dependency changes!"
              echo "üìù Changes detected:"
              git diff HEAD package.json | grep "express\|mongoose\|body-parser\|jsonwebtoken\|lodash\|got" || true
            else
              echo "‚ö†Ô∏è WARNING: package.json appears unchanged from original"
              echo "This means autofix likely failed to update dependencies"
            fi
            
            echo ""
            echo "üì¶ Current dependencies in package.json:"
            cat package.json | grep -A 20 '"dependencies"'
          else
            echo "‚ùå package.json not found - using original from checkout"
            exit 1
          fi
      
      - name: Install updated dependencies
        run: |
          echo "Installing dependencies with updated package.json..."
          npm install
          echo "‚úÖ Dependencies installed"
          echo ""
          echo "üì¶ Installed package versions:"
          npm list --depth=0 || true
      
      - name: Create reports directory
        run: mkdir -p reports/post-fix
      
      - name: Generate post-fix vulnerability report
        run: |
          echo "Generating post-fix vulnerability report..."
          node ./packages/audit/run-audit.js ./reports/post-fix
          echo "‚úÖ Post-fix report generated"
        continue-on-error: true
      
      - name: Display post-fix report
        run: |
          echo "üìã Post-Fix Vulnerability Report"
          echo "================================="
          if [ -f reports/post-fix/vulnerability_report.json ]; then
            cat reports/post-fix/vulnerability_report.json
          else
            echo "No vulnerability report found"
          fi
          
          if [ -f reports/post-fix/vulnerability_dashboard.json ]; then
            echo ""
            echo "üìä Post-Fix Vulnerability Dashboard:"
            cat reports/post-fix/vulnerability_dashboard.json
          fi
      
      - name: Generate Fixed Vulnerabilities Report
        run: |
          echo "üìä Generating Fixed Vulnerabilities Report"
          echo "==========================================="
          
          # Create Fixed Vulnerabilities report directory
          mkdir -p reports/fixed-vulnerabilities
          FIXED_REPORT="reports/fixed-vulnerabilities/Fixed_Vulnerabilities.txt"
          FIXED_JSON="reports/fixed-vulnerabilities/fixed_vulnerabilities.json"
          
          echo "==================================================" > $FIXED_REPORT
          echo "         FIXED VULNERABILITIES REPORT" >> $FIXED_REPORT
          echo "==================================================" >> $FIXED_REPORT
          echo "Generated: $(date)" >> $FIXED_REPORT
          echo "==================================================" >> $FIXED_REPORT
          echo "" >> $FIXED_REPORT
          
          # Compare pre-fix and post-fix dashboards
          if [ -f reports/pre-fix-comparison/vulnerability_dashboard.json ] && [ -f reports/post-fix/vulnerability_dashboard.json ]; then
            echo "Debug: Reading pre-fix dashboard..."
            cat reports/pre-fix-comparison/vulnerability_dashboard.json
            echo ""
            echo "Debug: Reading post-fix dashboard..."
            cat reports/post-fix/vulnerability_dashboard.json
            echo ""
            
            PRE_HIGH=$(cat reports/pre-fix-comparison/vulnerability_dashboard.json | grep -o '"high":[0-9]*' | cut -d: -f2)
            PRE_MODERATE=$(cat reports/pre-fix-comparison/vulnerability_dashboard.json | grep -o '"moderate":[0-9]*' | cut -d: -f2)
            PRE_LOW=$(cat reports/pre-fix-comparison/vulnerability_dashboard.json | grep -o '"low":[0-9]*' | cut -d: -f2)
            
            POST_HIGH=$(cat reports/post-fix/vulnerability_dashboard.json | grep -o '"high":[0-9]*' | cut -d: -f2)
            POST_MODERATE=$(cat reports/post-fix/vulnerability_dashboard.json | grep -o '"moderate":[0-9]*' | cut -d: -f2)
            POST_LOW=$(cat reports/post-fix/vulnerability_dashboard.json | grep -o '"low":[0-9]*' | cut -d: -f2)
            
            # Set defaults if empty
            PRE_HIGH=${PRE_HIGH:-0}
            PRE_MODERATE=${PRE_MODERATE:-0}
            PRE_LOW=${PRE_LOW:-0}
            POST_HIGH=${POST_HIGH:-0}
            POST_MODERATE=${POST_MODERATE:-0}
            POST_LOW=${POST_LOW:-0}
            
            echo "Debug: PRE_HIGH=$PRE_HIGH, PRE_MODERATE=$PRE_MODERATE, PRE_LOW=$PRE_LOW"
            echo "Debug: POST_HIGH=$POST_HIGH, POST_MODERATE=$POST_MODERATE, POST_LOW=$POST_LOW"
            
            DIFF_HIGH=$((PRE_HIGH - POST_HIGH))
            DIFF_MODERATE=$((PRE_MODERATE - POST_MODERATE))
            DIFF_LOW=$((PRE_LOW - POST_LOW))
            TOTAL_FIXED=$((DIFF_HIGH + DIFF_MODERATE + DIFF_LOW))
            
            echo "VULNERABILITY COUNTS" >> $FIXED_REPORT
            echo "--------------------" >> $FIXED_REPORT
            echo "" >> $FIXED_REPORT
            echo "Before Fix:" >> $FIXED_REPORT
            echo "  High:     $PRE_HIGH" >> $FIXED_REPORT
            echo "  Moderate: $PRE_MODERATE" >> $FIXED_REPORT
            echo "  Low:      $PRE_LOW" >> $FIXED_REPORT
            echo "  Total:    $((PRE_HIGH + PRE_MODERATE + PRE_LOW))" >> $FIXED_REPORT
            echo "" >> $FIXED_REPORT
            echo "After Fix:" >> $FIXED_REPORT
            echo "  High:     $POST_HIGH" >> $FIXED_REPORT
            echo "  Moderate: $POST_MODERATE" >> $FIXED_REPORT
            echo "  Low:      $POST_LOW" >> $FIXED_REPORT
            echo "  Total:    $((POST_HIGH + POST_MODERATE + POST_LOW))" >> $FIXED_REPORT
            echo "" >> $FIXED_REPORT
            echo "==================================================" >> $FIXED_REPORT
            echo "VULNERABILITIES FIXED" >> $FIXED_REPORT
            echo "==================================================" >> $FIXED_REPORT
            echo "" >> $FIXED_REPORT
            echo "  High:     $DIFF_HIGH fixed" >> $FIXED_REPORT
            echo "  Moderate: $DIFF_MODERATE fixed" >> $FIXED_REPORT
            echo "  Low:      $DIFF_LOW fixed" >> $FIXED_REPORT
            echo "" >> $FIXED_REPORT
            echo "  TOTAL:    $TOTAL_FIXED vulnerabilities fixed" >> $FIXED_REPORT
            echo "" >> $FIXED_REPORT
            
            if [ $TOTAL_FIXED -gt 0 ]; then
              echo "‚úÖ STATUS: SUCCESS" >> $FIXED_REPORT
              echo "==================================================" >> $FIXED_REPORT
            else
              echo "‚ö†Ô∏è  STATUS: NO FIXES APPLIED" >> $FIXED_REPORT
              echo "==================================================" >> $FIXED_REPORT
              echo "" >> $FIXED_REPORT
              echo "Possible reasons:" >> $FIXED_REPORT
              echo "  - API key not configured" >> $FIXED_REPORT
              echo "  - LLM API rate limit exceeded" >> $FIXED_REPORT
              echo "  - Autofix script encountered an error" >> $FIXED_REPORT
              echo "" >> $FIXED_REPORT
              echo "Check: reports/autofix/autofix-log.txt" >> $FIXED_REPORT
              echo "==================================================" >> $FIXED_REPORT
            fi
            
            # Create JSON version
            TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            PRE_TOTAL=$((PRE_HIGH + PRE_MODERATE + PRE_LOW))
            POST_TOTAL=$((POST_HIGH + POST_MODERATE + POST_LOW))
            if [ $TOTAL_FIXED -gt 0 ]; then
              STATUS="success"
            else
              STATUS="no_fixes"
            fi
            
            echo "{" > $FIXED_JSON
            echo "  \"generated\": \"$TIMESTAMP\"," >> $FIXED_JSON
            echo "  \"summary\": {" >> $FIXED_JSON
            echo "    \"total_fixed\": $TOTAL_FIXED," >> $FIXED_JSON
            echo "    \"high_fixed\": $DIFF_HIGH," >> $FIXED_JSON
            echo "    \"moderate_fixed\": $DIFF_MODERATE," >> $FIXED_JSON
            echo "    \"low_fixed\": $DIFF_LOW" >> $FIXED_JSON
            echo "  }," >> $FIXED_JSON
            echo "  \"before_fix\": {" >> $FIXED_JSON
            echo "    \"high\": $PRE_HIGH," >> $FIXED_JSON
            echo "    \"moderate\": $PRE_MODERATE," >> $FIXED_JSON
            echo "    \"low\": $PRE_LOW," >> $FIXED_JSON
            echo "    \"total\": $PRE_TOTAL" >> $FIXED_JSON
            echo "  }," >> $FIXED_JSON
            echo "  \"after_fix\": {" >> $FIXED_JSON
            echo "    \"high\": $POST_HIGH," >> $FIXED_JSON
            echo "    \"moderate\": $POST_MODERATE," >> $FIXED_JSON
            echo "    \"low\": $POST_LOW," >> $FIXED_JSON
            echo "    \"total\": $POST_TOTAL" >> $FIXED_JSON
            echo "  }," >> $FIXED_JSON
            echo "  \"status\": \"$STATUS\"" >> $FIXED_JSON
            echo "}" >> $FIXED_JSON
            
            cat $FIXED_REPORT
            echo ""
            echo "JSON report:"
            cat $FIXED_JSON
          else
            echo "‚ùå Could not generate comparison - missing reports" | tee -a $FIXED_REPORT
          fi
        continue-on-error: true
      
      - name: Delete post-fix vulnerability report files
        run: |
          echo "Removing post-fix vulnerability report files..."
          rm -f reports/post-fix/vulnerability_report.json
          rm -f reports/post-fix/vulnerability_dashboard.json
          echo "‚úÖ Post-fix vulnerability reports deleted"
        continue-on-error: true
      
      - name: Upload Fixed Vulnerabilities Report
        uses: actions/upload-artifact@v4
        with:
          name: fixed-vulnerabilities-report
          path: reports/fixed-vulnerabilities/
          if-no-files-found: warn
  
  test:
    name: Run Tests (npm test)
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Create reports directory
        run: mkdir -p reports/tests
      
      - name: Run tests
        run: |
          npm test > reports/tests/test-results.txt 2>&1 || true
      
      - name: Display test results
        run: |
          echo "üìã Test Results"
          if [ -f reports/tests/test-results.txt ]; then
            cat reports/tests/test-results.txt
          fi
      
      - name: Upload test report
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: reports/tests/
          if-no-files-found: warn
  
  pipeline-summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [setup, audit, generate-pre-fix-report, project-setup, start, py-setup, autofix, generate-post-fix-report, test]
    if: always()
    
    steps:
      - name: Check pipeline status
        run: |
          echo "=================================="
          echo "Pipeline Execution Summary"
          echo "=================================="
          echo ""
          echo "Job Results:"
          echo "  Setup: ${{ needs.setup.result }}"
          echo "  Audit: ${{ needs.audit.result }}"
          echo "  Pre-Fix Report: ${{ needs.generate-pre-fix-report.result }}"
          echo "  Project Setup: ${{ needs.project-setup.result }}"
          echo "  Start App: ${{ needs.start.result }}"
          echo "  Python Setup: ${{ needs.py-setup.result }}"
          echo "  Autofix: ${{ needs.autofix.result }}"
          echo "  Post-Fix Report: ${{ needs.generate-post-fix-report.result }}"
          echo "  Tests: ${{ needs.test.result }}"
          echo ""
          echo "=================================="
          
          if [ "${{ needs.setup.result }}" != "success" ]; then
            echo "‚ùå Setup job failed"
            exit 1
          fi
          
          echo "‚úÖ Pipeline Summary:"
          echo "   - All reports saved in reports/ folder"
          echo "   - Pre-Fix Report: reports/pre-fix/"
          echo "   - Fixed Vulnerabilities: reports/fixed-vulnerabilities/"
          echo "   - Project Setup: reports/project-setup/"
          echo "   - Start App: reports/start-app/"
          echo "   - Python Setup: reports/py-setup/"
          echo "   - Autofix Log: reports/autofix/"
          echo "   - Tests: reports/tests/"
          echo ""
          echo "‚úÖ All artifacts uploaded and available for download"
